# Kubernetes (K8)

## What is Kubernetes?
- Open source container orshestration tool
- Helps to manage containerised applications
- Can be used in phusical, virtual or cloud environments

![k8 architecture](https://miro.medium.com/max/1200/0*AnDIb4QsPzh1bnPx.jpg)
Source: <https://itnext.io/kubernetes-part-1-architecture-and-main-components-overview-a9ce97264a74>

## Why should we learn it?
- It improves productivity for the entire DevOps team
- It is open source, free, and future-proof
- It makes scaling up and down easy 
- It offers a variety of deployment options and patterns
- Festest-growing product software (after Linux)
- In-demand skill

## Who is using it?
Many companies are using Kubernetes. Some of them include:

- Airbnb
- Capital One
- eBay
- Goldman Sachs
- IBM
- Lyft
- New York Times
- Reddit
- Shopify
- Spotify

## What are the benefits to business?
- Cost savings for container orchestration
- Increased DevOps efficiency for microservices architecture
- Fast deliveries because of easy portability and scalability
- Kubernetes has a large ecosystem of complementary software projects and tools that make it easy to extend its functionality

## What are K8 objects?

Kubernetes objects are persistent entities in the Kubernetes system . Kubernetes uses these objects to represent the state of your cluster . Specifically, they can describe:

- What containerised applications are running (and on which nodes)
- The resources available to those applications
- The policies around how those applications behave, such as restart policies, upgrades, and fault-tolerance 

## Pods
- Pods abstract from containers
- Have their own IP address
- New IP address assigned upon relaunch

## Services
- Permanent IP address for each pod


[*Research  Deployment/s - replica sets - concept of labels and selectors in K8*]

# Deployment with K8
Make sure Kubernetes is installed. Run `kubectl` to get a list of K8 commands.

## Deploying Nginx
Ensure nginx image is running.

Create nginx-k8.yml file using `nano nginx-k8.yml`.

```
# YAML is case sensitive - indentation of YAML is important
# use spaces, not tab
apiVersion: apps/v1 # which api to use for deployment
kind: Deployment # pod - service what kind of service/object you want to create
# What would you like to call it - name the service/object
metadata:
  name: nginx-deployment # naming the deployment
spec:
  selector:
    matchLabels:
      app: nginx # look for this label to match with k8 service
  # Let's create a replica set of this with instances/pods
  replicas: 3 # 3 pods
  # template to use its label for k8 service to launch in the browser
  template:
    metadata:
      labels:
        app: nginx # This label connects to the service or any other k8 components
    # Let's define the container spec
    spec:
      containers:
      - name: nginx
        image: ddoxton/tech241-nginx:latest # Use the image that I built
        ports:
        - containerPort: 100
```

**Make sure it's the same port nginx is running on**.

To run this script:

```
kubectl create -f nginx-k8.yml
```

To make sure it's deployed:

```
kubectl get deployment
```

To check the pods:

```
kubectl get pods
```

![Imgur](https://i.imgur.com/zReHkN2.png)

## Troubleshooting
- `docker login`
- `docker run -d -p 97:80 ddoxton/tech241-nginx`
- Make sure the repo names match - ddoxton, not ddockers
- Use `kubectl get pods` to get pod names, and use `kubectl describe pod <name of pod>` to get description of potential errors
- If the image wasn't running at first, the k8 deployment needs to be deleted before re-creating. `kubectl delete deployment <name of deployment>`

## Deploying Node App
Ensure node app is running.

```
docker run -d -p 3000:3000 ddoxton/tech241-node-app
```

While in app folder, `nano node-k8.yml`.

```
apiVersion: apps/v1 # which api to use for deployment
kind: Deployment # pod - service what kind of service/object you want to create
# What would you like to call it - name the service/object
metadata:
  name: node # naming the deployment
spec:
  selector:
    matchLabels:
      app: node # look for this label to match with k8 service
  # Let's create a replica set of this with instances/pods
  replicas: 3 # 3 pods
  # template to use its label for k8 service to launch in the browser
  template: 
    metadata:
      labels:
        app: node # This label connects to the service or any other k8 components
    # Let's define the container spec
    spec:
      containers:
      - name: node
        image: ddoxton/tech241-node-app:latest # Use the image that I built
        ports:
        - containerPort: 3000
```
Create the deployment.
```
kubectl create -f node-k8.yml
```
```
kubectl get deployment
```
![Imgur](https://i.imgur.com/xyod2Dy.png)


